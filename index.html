<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Universal AI Chat</title>
    
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gemini: {
                            50: '#f8f9fa',
                            100: '#f1f3f4',
                            200: '#e8eaed',
                            800: '#202124',
                            900: '#131314'
                        }
                    }
                }
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* Custom scrollbar for webkit */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        
        /* Prose adjustments for dark mode & chat bubbles */
        .prose pre { background-color: #1e293b; color: #f8fafc; margin-top: 0.5em; margin-bottom: 0.5em; }
        .prose p { margin-top: 0.5em; margin-bottom: 0.5em; }
        .prose :first-child { margin-top: 0; }
        .prose :last-child { margin-bottom: 0; }
        
        /* Prevent layout shift */
        body { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-white dark:bg-gemini-900 text-gray-800 dark:text-gray-200 transition-colors duration-200 antialiased min-h-[100dvh] flex flex-col">

    <div id="loading" class="fixed inset-0 z-50 flex items-center justify-center bg-white dark:bg-gemini-900">
        <div class="flex flex-col items-center">
            <svg class="animate-spin h-10 w-10 text-blue-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-300">Loading App...</h2>
        </div>
    </div>

    <div id="app" class="hidden flex-1 flex w-full max-w-[1600px] mx-auto overflow-hidden relative min-h-[100dvh]">
        
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-20 hidden md:hidden transition-opacity"></div>

        <aside id="sidebar" class="fixed md:static inset-y-0 left-0 z-30 w-72 bg-gemini-50 dark:bg-gemini-800 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col border-r border-gray-200 dark:border-gray-700">
            <div class="p-4 flex items-center justify-between">
                <button id="btn-new-chat" class="flex-1 flex items-center gap-2 bg-white dark:bg-gemini-900 border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors rounded-full px-4 py-2.5 text-sm font-medium shadow-sm">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    New Chat
                </button>
                <button id="btn-close-sidebar" class="md:hidden p-2 ml-2 text-gray-500 hover:text-gray-800 dark:hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto px-3 py-2 space-y-1" id="chat-list">
                </div>

            <div class="p-4 border-t border-gray-200 dark:border-gray-700 space-y-2">
                <button id="btn-toggle-theme" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors text-sm font-medium text-left">
                    <svg class="w-5 h-5 dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    <svg class="w-5 h-5 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <span id="theme-text">Dark Mode</span>
                </button>
                <button id="btn-settings" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors text-sm font-medium text-left">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    Settings
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 bg-white dark:bg-gemini-900 relative">
            <header class="h-14 flex items-center px-4 sticky top-0 bg-white/80 dark:bg-gemini-900/80 backdrop-blur-md z-10 border-b border-transparent dark:border-transparent">
                <button id="btn-open-sidebar" class="md:hidden p-2 -ml-2 mr-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
                <div class="flex items-center gap-2 relative group cursor-pointer" id="header-model-display">
                    <span class="font-medium text-lg" id="current-chat-title">New Chat</span>
                    <span class="text-xs text-gray-500 bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded-md" id="current-model-badge">openrouter/free</span>
                </div>
            </header>

            <div id="messages-container" class="flex-1 overflow-y-auto px-4 sm:px-6 py-6 scroll-smooth">
                <div id="messages" class="max-w-3xl mx-auto space-y-8 pb-4">
                    <div id="welcome-screen" class="flex flex-col items-center justify-center h-full text-center mt-20 fade-in">
                        <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-2xl flex items-center justify-center mb-6 shadow-sm">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        </div>
                        <h1 class="text-3xl font-semibold mb-2">How can I help you today?</h1>
                        <p class="text-gray-500 dark:text-gray-400">Universal AI connected via OpenRouter.</p>
                    </div>
                </div>
            </div>

            <div class="px-4 pb-4 pt-2 sm:px-6 sticky bottom-0 bg-gradient-to-t from-white via-white dark:from-gemini-900 dark:via-gemini-900 to-transparent">
                <div class="max-w-3xl mx-auto relative">
                    <div class="relative flex items-end bg-gemini-100 dark:bg-gemini-800 rounded-3xl border border-gray-200 dark:border-gray-700 shadow-sm focus-within:ring-1 focus-within:ring-blue-500 focus-within:border-blue-500 transition-all">
                        <textarea id="chat-input" rows="1" placeholder="Message AI..." class="w-full bg-transparent border-0 focus:ring-0 resize-none py-4 pl-6 pr-14 max-h-48 overflow-y-auto dark:text-white dark:placeholder-gray-400 m-0 outline-none" style="min-height: 56px;"></textarea>
                        <button id="btn-send" class="absolute right-2 bottom-2 p-2 rounded-full text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:bg-gray-300 dark:disabled:bg-gray-700 disabled:text-gray-500 transition-colors flex items-center justify-center h-10 w-10">
                            <svg class="w-5 h-5 translate-x-[-1px] translate-y-[1px]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                        </button>
                    </div>
                    <div class="text-center text-xs text-gray-400 dark:text-gray-500 mt-2">
                        AI can make mistakes. Consider verifying important information.
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gemini-800 rounded-2xl w-full max-w-md shadow-2xl flex flex-col max-h-[90vh]">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <h3 class="text-lg font-semibold">Settings</h3>
                <button id="btn-close-settings" class="text-gray-500 hover:text-gray-800 dark:hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Model</label>
                    <select id="model-select" class="w-full bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="openrouter/free">Recommend: openrouter/free</option>
                        <option value="arcee-ai/trinity-large-preview:free">Smart: arcee-ai/trinity-large-preview:free</option>
                        <option value="cognitivecomputations/dolphin-mistral-24b-venice-edition:free">Uncensored: Dolphin Mistral</option>
                        <option value="stepfun/step-3.5-flash:free">Roleplay: stepfun/step-3.5-flash:free</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Global System Prompt</label>
                    <textarea id="system-prompt-input" rows="4" class="w-full bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none resize-y" placeholder="You are a helpful assistant..."></textarea>
                    <p class="text-xs text-gray-500 mt-1">Applied to all new chats.</p>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gemini-900 rounded-b-2xl flex justify-end">
                <button id="btn-save-settings" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-medium transition-colors">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <script>
        // Use an IIFE to avoid global scope pollution
        (function() {
            // ==========================================
            // CONFIG & STATE
            // ==========================================
            // API Key strictly hidden in closure. (Note: Exposed to network tab natively in frontend architectures)
            const API_KEY = "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";
            const API_URL = "https://openrouter.ai/api/v1/chat/completions";

            let state = {
                chats: [], // { id, title, messages: [] }
                currentChatId: null,
                isGenerating: false,
                settings: {
                    model: 'openrouter/free',
                    systemPrompt: 'You are a helpful, smart, and concise AI assistant.',
                    theme: 'system' // 'light', 'dark', 'system'
                }
            };

            let abortController = null;

            // ==========================================
            // DOM ELEMENTS
            // ==========================================
            const els = {
                app: document.getElementById('app'),
                loading: document.getElementById('loading'),
                sidebar: document.getElementById('sidebar'),
                sidebarOverlay: document.getElementById('sidebarOverlay'),
                chatList: document.getElementById('chat-list'),
                messages: document.getElementById('messages'),
                messagesContainer: document.getElementById('messages-container'),
                welcomeScreen: document.getElementById('welcome-screen'),
                chatInput: document.getElementById('chat-input'),
                btnSend: document.getElementById('btn-send'),
                btnNewChat: document.getElementById('btn-new-chat'),
                btnOpenSidebar: document.getElementById('btn-open-sidebar'),
                btnCloseSidebar: document.getElementById('btn-close-sidebar'),
                sidebarOverlay: document.getElementById('sidebar-overlay'),
                btnToggleTheme: document.getElementById('btn-toggle-theme'),
                themeText: document.getElementById('theme-text'),
                btnSettings: document.getElementById('btn-settings'),
                settingsModal: document.getElementById('settings-modal'),
                btnCloseSettings: document.getElementById('btn-close-settings'),
                btnSaveSettings: document.getElementById('btn-save-settings'),
                modelSelect: document.getElementById('model-select'),
                systemPromptInput: document.getElementById('system-prompt-input'),
                currentChatTitle: document.getElementById('current-chat-title'),
                currentModelBadge: document.getElementById('current-model-badge')
            };

            // ==========================================
            // INITIALIZATION
            // ==========================================
            function init() {
                loadState();
                applyTheme();
                setupEventListeners();
                
                if (state.chats.length === 0) {
                    createNewChat();
                } else {
                    if (!state.currentChatId) state.currentChatId = state.chats[0].id;
                    renderChatList();
                    loadCurrentChat();
                }

                els.currentModelBadge.textContent = state.settings.model.split('/').pop() || 'model';

                // Hide loader, show app
                setTimeout(() => {
                    els.loading.style.display = 'none';
                    els.app.classList.remove('hidden');
                }, 100);
            }

            // ==========================================
            // STORAGE & STATE MANAGEMENT
            // ==========================================
            function loadState() {
                try {
                    const savedChats = localStorage.getItem('geminiCloneChats');
                    const savedSettings = localStorage.getItem('geminiCloneSettings');
                    if (savedChats) state.chats = JSON.parse(savedChats);
                    if (savedSettings) state.settings = { ...state.settings, ...JSON.parse(savedSettings) };
                } catch (e) {
                    console.error("Failed to load local storage:", e);
                }
            }

            function saveState() {
                try {
                    localStorage.setItem('geminiCloneChats', JSON.stringify(state.chats));
                    localStorage.setItem('geminiCloneSettings', JSON.stringify(state.settings));
                } catch (e) {
                    console.error("Failed to save local storage:", e);
                }
            }

            function getCurrentChat() {
                return state.chats.find(c => c.id === state.currentChatId);
            }

            // ==========================================
            // EVENT LISTENERS
            // ==========================================
            function setupEventListeners() {
                // Input auto-resize
                els.chatInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                    updateSendButtonState();
                });

                // Enter to send (shift+enter for new line)
                els.chatInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        handleSend();
                    }
                });

                els.btnSend.addEventListener('click', handleSend);
                els.btnNewChat.addEventListener('click', createNewChat);

                // Sidebar Mobile Toggles
                els.btnOpenSidebar.addEventListener('click', () => toggleSidebar(true));
                els.btnCloseSidebar.addEventListener('click', () => toggleSidebar(false));
                els.sidebarOverlay.addEventListener('click', () => toggleSidebar(false));

                // Settings
                els.btnSettings.addEventListener('click', openSettings);
                els.btnCloseSettings.addEventListener('click', closeSettings);
                els.btnSaveSettings.addEventListener('click', saveSettings);
                
                // Theme
                els.btnToggleTheme.addEventListener('click', toggleTheme);

                // Chat list delegation
                els.chatList.addEventListener('click', (e) => {
                    const btn = e.target.closest('[data-chat-id]');
                    if (!btn) return;
                    
                    const chatId = btn.dataset.chatId;
                    
                    if (e.target.closest('.delete-chat')) {
                        e.stopPropagation();
                        deleteChat(chatId);
                    } else if (e.target.closest('.rename-chat')) {
                        e.stopPropagation();
                        renameChat(chatId);
                    } else {
                        switchChat(chatId);
                        if (window.innerWidth < 768) toggleSidebar(false);
                    }
                });
            }

            // ==========================================
            // UI FUNCTIONS
            // ==========================================
            function toggleSidebar(show) {
                if (show) {
                    els.sidebar.classList.remove('-translate-x-full');
                    els.sidebarOverlay.classList.remove('hidden');
                } else {
                    els.sidebar.classList.add('-translate-x-full');
                    els.sidebarOverlay.classList.add('hidden');
                }
            }

            function openSettings() {
                els.modelSelect.value = state.settings.model;
                els.systemPromptInput.value = state.settings.systemPrompt;
                els.settingsModal.classList.remove('hidden');
            }

            function closeSettings() {
                els.settingsModal.classList.add('hidden');
            }

            function saveSettings() {
                state.settings.model = els.modelSelect.value;
                state.settings.systemPrompt = els.systemPromptInput.value;
                els.currentModelBadge.textContent = state.settings.model.split('/').pop();
                saveState();
                closeSettings();
            }

            function applyTheme() {
                const html = document.documentElement;
                let isDark = false;
                
                if (state.settings.theme === 'dark') {
                    isDark = true;
                } else if (state.settings.theme === 'system') {
                    isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                }

                if (isDark) {
                    html.classList.add('dark');
                    els.themeText.textContent = 'Light Mode';
                } else {
                    html.classList.remove('dark');
                    els.themeText.textContent = 'Dark Mode';
                }
            }

            function toggleTheme() {
                const isCurrentlyDark = document.documentElement.classList.contains('dark');
                state.settings.theme = isCurrentlyDark ? 'light' : 'dark';
                applyTheme();
                saveState();
            }

            function updateSendButtonState() {
                const text = els.chatInput.value.trim();
                if (text.length > 0 && !state.isGenerating) {
                    els.btnSend.removeAttribute('disabled');
                } else {
                    els.btnSend.setAttribute('disabled', 'true');
                }

                // Transform button to Stop if generating
                if (state.isGenerating) {
                    els.btnSend.innerHTML = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" rx="2"></rect></svg>`;
                    els.btnSend.removeAttribute('disabled');
                    els.btnSend.classList.add('bg-red-600', 'hover:bg-red-700');
                    els.btnSend.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                } else {
                    els.btnSend.innerHTML = `<svg class="w-5 h-5 translate-x-[-1px] translate-y-[1px]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>`;
                    els.btnSend.classList.remove('bg-red-600', 'hover:bg-red-700');
                    els.btnSend.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }
            }

            function scrollToBottom() {
                els.messagesContainer.scrollTop = els.messagesContainer.scrollHeight;
            }

            // ==========================================
            // CHAT LOGIC
            // ==========================================
            function createNewChat() {
                const newChat = {
                    id: Date.now().toString(),
                    title: 'New Chat',
                    messages: []
                };
                state.chats.unshift(newChat);
                switchChat(newChat.id);
                if (window.innerWidth < 768) toggleSidebar(false);
            }

            function switchChat(id) {
                if (state.isGenerating) stopGeneration();
                state.currentChatId = id;
                renderChatList();
                loadCurrentChat();
            }

            function deleteChat(id) {
                if (!confirm("Are you sure you want to delete this chat?")) return;
                state.chats = state.chats.filter(c => c.id !== id);
                if (state.chats.length === 0) createNewChat();
                else if (state.currentChatId === id) switchChat(state.chats[0].id);
                else renderChatList();
                saveState();
            }

            function renameChat(id) {
                const chat = state.chats.find(c => c.id === id);
                if (!chat) return;
                const newTitle = prompt("Enter new title:", chat.title);
                if (newTitle && newTitle.trim()) {
                    chat.title = newTitle.trim();
                    renderChatList();
                    if (state.currentChatId === id) els.currentChatTitle.textContent = chat.title;
                    saveState();
                }
            }

            function renderChatList() {
                els.chatList.innerHTML = state.chats.map(chat => `
                    <div class="group flex items-center justify-between px-3 py-2.5 rounded-lg cursor-pointer transition-colors ${chat.id === state.currentChatId ? 'bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300' : 'hover:bg-gray-200 dark:hover:bg-gray-700/50'}" data-chat-id="${chat.id}">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <svg class="w-4 h-4 shrink-0 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                            <span class="truncate text-sm font-medium">${escapeHTML(chat.title)}</span>
                        </div>
                        <div class="hidden group-hover:flex items-center gap-1 shrink-0 bg-gradient-to-l from-gray-200 dark:from-gray-700 pl-2">
                            <button class="rename-chat p-1 text-gray-500 hover:text-blue-600 rounded" title="Rename">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                            </button>
                            <button class="delete-chat p-1 text-gray-500 hover:text-red-600 rounded" title="Delete">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            function loadCurrentChat() {
                const chat = getCurrentChat();
                if (!chat) return;

                els.currentChatTitle.textContent = chat.title;
                els.messages.innerHTML = '';
                
                if (chat.messages.length === 0) {
                    els.messages.appendChild(els.welcomeScreen);
                    els.welcomeScreen.classList.remove('hidden');
                } else {
                    els.welcomeScreen.classList.add('hidden');
                    chat.messages.forEach(msg => appendMessageUI(msg.role, msg.content, false));
                }
                setTimeout(scrollToBottom, 50);
            }

            // ==========================================
            // MESSAGING & STREAMING
            // ==========================================
            function escapeHTML(str) {
                return str.replace(/[&<>'"]/g, 
                    tag => ({
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        "'": '&#39;',
                        '"': '&quot;'
                    }[tag])
                );
            }

            function createMessageElement(role) {
                const div = document.createElement('div');
                div.className = `flex gap-4 w-full ${role === 'user' ? 'flex-row-reverse' : ''}`;
                
                const avatar = document.createElement('div');
                avatar.className = `w-8 h-8 rounded-full flex items-center justify-center shrink-0 ${role === 'user' ? 'bg-blue-600 text-white' : 'bg-gradient-to-br from-indigo-500 to-purple-600 text-white shadow-sm'}`;
                avatar.innerHTML = role === 'user' 
                    ? `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>`
                    : `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>`;

                const contentWrapper = document.createElement('div');
                contentWrapper.className = `max-w-[85%] ${role === 'user' ? 'bg-gray-100 dark:bg-gray-800 rounded-2xl rounded-tr-sm px-5 py-3' : 'prose dark:prose-invert prose-sm sm:prose-base pt-1 min-w-0'}`;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'content';

                contentWrapper.appendChild(contentDiv);
                div.appendChild(avatar);
                div.appendChild(contentWrapper);
                
                return { element: div, contentDiv };
            }

            function appendMessageUI(role, text, isStreaming = false) {
                els.welcomeScreen.classList.add('hidden');
                const { element, contentDiv } = createMessageElement(role);
                
                if (role === 'user') {
                    contentDiv.textContent = text; // Plain text for user
                } else {
                    contentDiv.innerHTML = marked.parse(text); // Markdown for AI
                }

                els.messages.appendChild(element);
                scrollToBottom();
                return contentDiv;
            }

            function stopGeneration() {
                if (abortController) {
                    abortController.abort();
                    abortController = null;
                }
                state.isGenerating = false;
                updateSendButtonState();
            }

            async function handleSend() {
                if (state.isGenerating) {
                    stopGeneration();
                    return;
                }

                const text = els.chatInput.value.trim();
                if (!text) return;

                const chat = getCurrentChat();
                if (!chat) return;

                // 1. Add User Message
                els.chatInput.value = '';
                els.chatInput.style.height = 'auto';
                chat.messages.push({ role: 'user', content: text });
                appendMessageUI('user', text);
                saveState();

                // Generate Title if first message
                if (chat.messages.length === 1) {
                    chat.title = text.length > 25 ? text.substring(0, 25) + '...' : text;
                    els.currentChatTitle.textContent = chat.title;
                    renderChatList();
                }

                // 2. Setup AI Response Element
                state.isGenerating = true;
                updateSendButtonState();
                const aiContentDiv = appendMessageUI('assistant', '<span class="animate-pulse">● ● ●</span>');
                
                // Build Payload
                const apiMessages = [
                    { role: 'system', content: state.settings.systemPrompt },
                    ...chat.messages.map(m => ({ role: m.role, content: m.content }))
                ];

                abortController = new AbortController();

                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${API_KEY}`
                        },
                        body: JSON.stringify({
                            model: state.settings.model,
                            messages: apiMessages,
                            stream: true
                        }),
                        signal: abortController.signal
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error?.message || `API Error: ${response.status}`);
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder("utf-8");
                    let aiFullText = "";
                    let buffer = "";

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop(); // Keep partial line in buffer

                        for (const line of lines) {
                            if (line.trim() === '') continue;
                            if (line.startsWith('data: ')) {
                                const dataStr = line.slice(6);
                                if (dataStr === '[DONE]') break;
                                
                                try {
                                    const parsed = JSON.parse(dataStr);
                                    const delta = parsed.choices[0]?.delta?.content || "";
                                    if (delta) {
                                        aiFullText += delta;
                                        // Use marked for real-time markdown rendering
                                        aiContentDiv.innerHTML = marked.parse(aiFullText + '▌');
                                        scrollToBottom();
                                    }
                                } catch (e) {
                                    console.warn("SSE Parse error", e, line);
                                }
                            }
                        }
                    }

                    // Finalize response
                    aiContentDiv.innerHTML = marked.parse(aiFullText);
                    chat.messages.push({ role: 'assistant', content: aiFullText });
                    saveState();

                } catch (error) {
                    if (error.name !== 'AbortError') {
                        aiContentDiv.innerHTML = `<span class="text-red-500">Error: ${escapeHTML(error.message)}</span>`;
                        chat.messages.push({ role: 'assistant', content: `Error: ${error.message}` });
                        saveState();
                    } else {
                        // Keep whatever was generated so far
                        const currentText = aiContentDiv.innerText.replace('▌', '');
                        aiContentDiv.innerHTML = marked.parse(currentText);
                        chat.messages.push({ role: 'assistant', content: currentText });
                        saveState();
                    }
                } finally {
                    state.isGenerating = false;
                    abortController = null;
                    updateSendButtonState();
                    els.chatInput.focus();
                }
            }

            // Run App
            init();

        })();
    </script>
</body>
</html>